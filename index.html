<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF Friendship Demo</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #errorMessage { color: red; }
        #friendshipStatus { margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>LINEミニアプリ 友だち確認デモ</h1>

    <p id="profileInfo">Loading user info...</p>
    <p id="friendshipStatus"></p>
    <p id="errorMessage"></p>

    <script>
        // 自身のLIFF IDに置き換えてください
        const MY_LIFF_ID = "2007015940-Nrw3nRxd";
        // 自身のLINE公式アカウントのID（@から始まるもの）に置き換えてください
        const MY_BOT_ID = "@800dhxkb";

        async function initializeLiff() {
            const profileInfoElement = document.getElementById("profileInfo");
            const errorElement = document.getElementById("errorMessage");
            
            try {
                // LIFFを初期化
                await liff.init({ liffId: MY_LIFF_ID });

                // ログイン状態をチェック
                if (!liff.isLoggedIn()) {
                    // 未ログインの場合、ユーザーにログインが必要なことを伝える
                    profileInfoElement.innerText = "サービスの利用にはLINEログインが必要です。ログイン画面に移動します。";
                    
                    // liff.login() を呼び出してLINEログインのフローを開始
                    // ログイン後、同じページにリダイレクトされて戻ってくる
                    liff.login();
                    
                    // liff.login()はページをリダイレクトさせるため、これ以降のコードはこの実行では処理されない。
                    // ログイン成功後にページが再読み込みされ、再度このinitializeLiff関数が実行されるのを待つ。
                    return; 
                }

                // ===== ログイン済みの場合の処理 =====
                profileInfoElement.innerText = "ログイン情報を取得中です...";
                const profile = await liff.getProfile();
                profileInfoElement.innerText = `ようこそ、${profile.displayName} さん！友だち状態を確認します...`;

                // プロフィール取得後、自動的に友だち確認処理を実行
                await checkFriendship();

            } catch (error) {
                profileInfoElement.innerText = "処理中にエラーが発生しました。";
                errorElement.innerText = `エラー: ${error.message}`;
                console.error("LIFF Error", error);
            }
        }

        async function checkFriendship() {
            const statusElement = document.getElementById("friendshipStatus");
            const errorElement = document.getElementById("errorMessage");
            statusElement.innerText = ""; // 前回の結果をクリア
            errorElement.innerText = ""; // 前回のエラーをクリア
            
            try {
                const friendship = await liff.getFriendship();

                if (friendship.friendFlag) {
                    statusElement.innerText = "あなたは公式アカウントの友だちです！";
                } else {
                    statusElement.innerText = "あなたはまだ公式アカウントの友だちではありません。";
                    // 外部ブラウザでは友だち追加の直接遷移は効果が薄いため、
                    // メッセージ表示や、QRコードを表示するなどの案内に留めるのが一般的
                    const addFriendUrl = `https://line.me/R/ti/p/${MY_BOT_ID}`;
                    statusElement.innerHTML += `<br><a href="${addFriendUrl}" target="_blank" rel="noopener noreferrer">こちらのリンクから友だち追加してください。</a>`;
                }

            } catch (error) {
                errorElement.innerText = `友だち確認中にエラーが発生しました: ${error.message}`;
                statusElement.innerText = "友だち状態の確認に失敗しました。";
                console.error("Error checking friendship:", error);
            }
        }

        // ページ読み込み時にLIFFを初期化し、自動的に処理を開始
        window.onload = async () => {
            await initializeLiff();
        };
    </script>
</body>
</html>
