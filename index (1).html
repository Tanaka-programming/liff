<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF Friendship Demo</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #errorMessage { color: red; }
        #friendshipStatus { margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>LINEミニアプリ 友だち確認デモ</h1>

    <p id="profileInfo">Loading user info...</p>
    <p id="friendshipStatus"></p>
    <p id="errorMessage"></p>

    <script>
        // 自身のLIFF IDに置き換えてください
        const MY_LIFF_ID = "2007015940-Nrw3nRxd";
        // 自身のLINE公式アカウントのID（@から始まるもの）に置き換えてください
        const MY_BOT_ID = "@800dhxkb";

        async function initializeLiff() {
            const profileInfoElement = document.getElementById("profileInfo");
            const errorElement = document.getElementById("errorMessage");
            try {
                await liff.init({ liffId: MY_LIFF_ID });

                if (!liff.isLoggedIn()) {
                    profileInfoElement.innerText = "LINEにログインしていません。ログイン画面に移動します...";
                    
                    // ★★★ 変更点 ★★★
                    // 自動ログインを無効にして、SSO確認画面を意図的に表示させる
                    liff.login({
                        disable_auto_login: true
                    });
                    
                    // liff.login()を呼び出すとページがリダイレクトされるため、以降の処理は行われない
                    return;
                }

                // ログイン済みの場合
                const profile = await liff.getProfile();
                profileInfoElement.innerText = `ようこそ、${profile.displayName} さん！友だち状態を確認します...`;

                // プロフィール取得後、自動的に友だち確認処理を実行
                await checkFriendship();

            } catch (error) {
                profileInfoElement.innerText = "LIFF初期化またはプロフィール取得に失敗しました。";
                errorElement.innerText = `エラー: ${error.message}`;
                console.error("LIFF Initialization or Profile failed", error);
            }
        }

        async function checkFriendship() {
            const statusElement = document.getElementById("friendshipStatus");
            const errorElement = document.getElementById("errorMessage");
            statusElement.innerText = ""; // 前回の結果をクリア
            errorElement.innerText = ""; // 前回のエラーをクリア
            
            if (!liff.isLoggedIn()) {
                statusElement.innerText = "再度ログインが必要です。ページをリロードするか、アプリを再起動してください。";
                return;
            }

            try {
                const friendship = await liff.getFriendship();

                if (friendship.friendFlag) {
                    statusElement.innerText = "あなたは公式アカウントの友だちです！ミニアプリをご利用いただけます。";
                    // ここで友だち向けのミニアプリのメインコンテンツを表示するなどの処理を行う
                } else {
                    statusElement.innerText = "あなたはまだ公式アカウントの友だちではありません。友だち追加ページに移動します。";
                    // 友だちでない場合の遷移処理
                    const addFriendUrl = `https://line.me/R/ti/p/${MY_BOT_ID}`;
                    liff.openWindow({
                        url: addFriendUrl,
                        external: false // 友だち追加URLはLINEアプリ内で処理する
                    });
                }

            } catch (error) {
                errorElement.innerText = `友だち確認中にエラーが発生しました: ${error.message}`;
                statusElement.innerText = "友だち状態の確認に失敗しました。しばらくしてから再度お試しください。";
                console.error("Error checking friendship:", error);
            }
        }

        // ページ読み込み時にLIFFを初期化し、自動的に処理を開始
        window.onload = async () => {
            await initializeLiff();
        };
    </script>
</body>
</html>
